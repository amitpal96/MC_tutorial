Bootstrap: localimage
From: work_container/

%files
    Generator-R-3_04_00.tar.gz /opt/

%post
    # Update apt and install emacs
    apt-get update && apt-get install -y emacs \
        && rm -rf /var/lib/apt/lists/*

    # Set noninteractive frontend for apt
    #export DEBIAN_FRONTEND=noninteractive

    # Install build tools and ROOT dependencies
    #apt-get update && apt-get install -y \
    #    build-essential cmake gfortran git wget curl \
    #    python3 python3-pip python-is-python3 \
    #    autoconf automake libtool pkg-config \
    #    libx11-dev libxpm-dev libxft-dev libxext-dev \
    #    libx11-6 libxpm4 libxft2 libxext6 \
    #    libtbb2 libtbb-dev \
    #    libxxhash0 liblz4-1 libssl1.1 \
    #    tzdata \
    #    && rm -rf /var/lib/apt/lists/*

    # Set timezone to avoid prompts
    #ln -fs /usr/share/zoneinfo/Asia/Kolkata /etc/localtime
    #dpkg-reconfigure --frontend noninteractive tzdata


     cd /opt
     tar -xzf Generator-R-3_04_00.tar.gz
     mv Generator-R-3_04_00 GENIE
     mkdir -p /opt/genie_install
     export GENIE=/opt/GENIE
     cd $GENIE
     ./configure --prefix=/opt/genie_install \
           --disable-profiler --disable-validation-tools --disable-cernlib \
    	   --enable-lhapdf6 --enable-flux-drivers --enable-geom-drivers \
    	   --disable-doxygen --enable-test --enable-mueloss --enable-dylibversion \
    	   --enable-t2k --enable-fnal --enable-atmo --enable-nucleon-decay \
    	   --enable-boosted-dark-matter --enable-dark-neutrino \
    	   --enable-nnbar-oscillation --enable-neutral-heavy-lepton \
    	   --disable-masterclass --disable-debug --with-optimiz-level=O2 \
    	   --with-pythia6-lib=/opt/pythia6/pythia6428 \
	   --with-lhapdf6-inc=/opt/lhapdf_install/include \
    	   --with-lhapdf6-lib=/opt/lhapdf_install/lib \
    	   --with-log4cpp-inc=/opt/log4cpp_install/include \
    	   --with-log4cpp-lib=/opt/log4cpp_install/lib \
    	   --with-libxml2-inc=/opt/libxml2_install/include/libxml2 \
    	   --with-libxml2-lib=/opt/libxml2_install/lib


      make -j$(nproc)
      make install
      cp -r /opt/GENIE/config /opt/genie_install/share/
      cp -r /opt/GENIE/data /opt/genie_install/share/
      cp -r /opt/GENIE/src/scripts /opt/genie_install/share/scripts
      mkdir -p /opt/genie_install/src/scripts/gcint
      cp -r /opt/GENIE/src/scripts/gcint/* /opt/genie_install/src/scripts/gcint/
      mkdir -p /opt/genie_install/src/make
      cp /opt/GENIE/src/make/Make.config_no_paths /opt/genie_install/src/make/

      ###########
      #  NUWRO  #
      ###########
      cd /opt
      git clone https://github.com/NuWro/nuwro.git
      cd nuwro
      # Set library path for linking
      export LIBRARY_PATH=/opt/pythia6/pythia6428:$LIBRARY_PATH
      export LD_LIBRARY_PATH=/opt/pythia6/pythia6428:$LD_LIBRARY_PATH
      export ROOTSYS=/opt/root

      make clean
      make

%environment
    # GENIE
    export GENIE=/opt/genie_install
    export GENIE_INC_DIR=$GENIE/include
    export GENIE_LIB=$GENIE/lib
    export PATH=$GENIE/bin:$PATH
    #export LD_LIBRARY_PATH=$GENIE_LIB:$LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=$GENIE_LIB:/opt/pythia6/pythia6428:$LD_LIBRARY_PATH
    export ROOT_INCLUDE_PATH=/opt/genie_install/include:$ROOT_INCLUDE_PATH
    # GENIE needs these runtime paths
    export GXMLPATH=/opt/GENIE/config
    export GMSGLIB=$GXMLPATH/Messenger.xml

     # NuWro environment
    export NUWRO=/opt/nuwro
    export PATH=$NUWRO/bin:$PATH

    # PYTHIA6
    export PYTHIA6=/opt/pythia6/pythia6428
    export LD_LIBRARY_PATH=$PYTHIA6:$LD_LIBRARY_PATH
    export LIBRARY_PATH=$PYTHIA6:$LIBRARY_PATH

    # ROOT
    export ROOTSYS=/opt/root
    export PATH=$ROOTSYS/bin:$PATH
    export LD_LIBRARY_PATH=$ROOTSYS/lib:$LD_LIBRARY_PATH
    export ROOT_INCLUDE_PATH=$ROOTSYS/include:$ROOT_INCLUDE_PATH